version: 2.1

jobs:
  deploy-development:
    docker:
      - image: cimg/php:8.2

    steps:
      - checkout

      - run:
          name: ğŸ§© Instalar dependencias PHP (composer, DEV)
          command: |
            composer install \
              --no-interaction \
              --prefer-dist \
              --optimize-autoloader

      - run:
          name: ğŸ“‚ Listar directorio raÃ­z
          command: ls -la

      - run:
          name: ğŸ“‚ Listar directorio public
          command: |
            ls -la public || echo "No existe el directorio public"

      - run:
          name: ğŸ“‚ Listar directorio public/assets
          command: |
            ls -la public/assets || echo "No existe el directorio public/assets"

      - run:
          name: ğŸ› ï¸ Instalar lftp
          command: |
            sudo apt-get update
            sudo apt-get install -y lftp

      - run:
          name: ğŸ“‚ Sync files (DEV, excepto public/ and others)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R . $intra_ftp_dev_path \
              --verbose \
              --exclude-glob public/** \
              --exclude-glob .git/** \
              --exclude-glob .circleci/** \
              --exclude-glob .env \
              --exclude-glob .env.prod \
              --exclude-glob .env.dev \
              --exclude-glob composer.lock \
              --exclude-glob storage/logs/** \
              --exclude-glob config/local.php; \
              quit"

      - run:
          name: ğŸ“ Update assets (DEV)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R $local_dir $intra_ftp_dev_assets_path --verbose; quit"

  deploy-production:
    docker:
      - image: cimg/php:8.2

    steps:
      - checkout

      - run:
          name: ğŸ§© Instalar dependencias PHP (composer, PROD)
          command: |
            composer install \
              --no-dev \
              --no-interaction \
              --prefer-dist \
              --optimize-autoloader

      - run:
          name: ğŸ“‚ Listar directorio raÃ­z
          command: ls -la

      - run:
          name: ğŸ“‚ Listar directorio public
          command: |
            ls -la public || echo "No existe el directorio public"

      - run:
          name: ğŸ“‚ Listar directorio public/assets
          command: |
            ls -la public/assets || echo "No existe el directorio public/assets"

      - run:
          name: ğŸ› ï¸ Instalar lftp
          command: |
            sudo apt-get update
            sudo apt-get install -y lftp

      - run:
          name: ğŸ“‚ Sync files (PROD, excepto public/ and others)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R . $intra_ftp_prod_path \
              --verbose \
              --exclude-glob public/** \
              --exclude-glob .git/** \
              --exclude-glob .circleci/** \
              --exclude-glob .env \
              --exclude-glob .env.prod \
              --exclude-glob .env.dev \
              --exclude-glob composer.lock \
              --exclude-glob storage/logs/** \
              --exclude-glob config/local.php; \
              quit"

      - run:
          name: ğŸ“ Update assets (PROD)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R $local_dir $intra_ftp_prod_assets_path --verbose; quit"

workflows:
  deploy-on-branches:
    jobs:
      - deploy-development:
          filters:
            branches:
              only: development

      - deploy-production:
          filters:
            branches:
              only: main
