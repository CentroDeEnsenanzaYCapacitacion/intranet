version: 2.1

jobs:
  deploy-development:
    docker:
      - image: cimg/php:8.2

    steps:
      - checkout

      - run:
          name: üîé Detectar cambios en dependencias (DEV)
          command: |
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              CHANGED_FILES="$(git diff --name-only HEAD^ HEAD)"
              echo "Archivos modificados:"
              echo "$CHANGED_FILES"
              if echo "$CHANGED_FILES" | grep -E '(^|/)composer\.json$|(^|/)composer\.lock$' >/dev/null; then
                echo "Se han detectado cambios en dependencias."
                echo 'COMPOSER_CHANGED=yes' >> "$BASH_ENV"
              else
                echo "No hay cambios en composer.json / composer.lock."
                echo 'COMPOSER_CHANGED=no' >> "$BASH_ENV"
              fi
            else
              echo "No hay commit previo (primer build); asumimos cambios en dependencias."
              echo 'COMPOSER_CHANGED=yes' >> "$BASH_ENV"
            fi

      - run:
          name: üß© Instalar dependencias PHP (composer, DEV)
          command: |
            if [ "$COMPOSER_CHANGED" = "yes" ]; then
              echo "COMPOSER_CHANGED=yes ‚Üí ejecutando composer install"
              composer install \
                --no-interaction \
                --prefer-dist \
                --optimize-autoloader
            else
              echo "COMPOSER_CHANGED=no ‚Üí se omite composer install"
            fi

      - run:
          name: üìÇ Listar directorio ra√≠z
          command: ls -la

      - run:
          name: üìÇ Listar directorio public
          command: |
            ls -la public || echo "No existe el directorio public"

      - run:
          name: üìÇ Listar directorio public/assets
          command: |
            ls -la public/assets || echo "No existe el directorio public/assets"

      - run:
          name: üõ†Ô∏è Instalar lftp
          command: |
            sudo apt-get update
            sudo apt-get install -y lftp

      - run:
          name: üìÇ Sync files (DEV, excepto public/, vendor y otros)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R . $intra_ftp_dev_path \
              --verbose \
              --exclude-glob public/** \
              --exclude-glob vendor/** \
              --exclude-glob .git/** \
              --exclude-glob .circleci/** \
              --exclude-glob .env \
              --exclude-glob .env.prod \
              --exclude-glob .env.dev \
              --exclude-glob .env.example \
              --exclude-glob composer.lock \
              --exclude-glob storage/logs/** \
              --exclude-glob config/local.php; \
              quit"

      - run:
          name: üì¶ Sync vendor (DEV)
          command: |
            if [ "$COMPOSER_CHANGED" = "yes" ]; then
              echo "COMPOSER_CHANGED=yes ‚Üí sincronizando vendor/"
              lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R vendor $intra_ftp_dev_path/vendor \
                --verbose; \
                quit"
            else
              echo "COMPOSER_CHANGED=no ‚Üí no se sincroniza vendor/"
            fi

      - run:
          name: üìÅ Update assets (DEV)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R $local_dir $intra_ftp_dev_assets_path --verbose; quit"

  deploy-production:
    docker:
      - image: cimg/php:8.2

    steps:
      - checkout

      - run:
          name: üîé Detectar cambios en dependencias (PROD)
          command: |
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              CHANGED_FILES="$(git diff --name-only HEAD^ HEAD)"
              echo "Archivos modificados:"
              echo "$CHANGED_FILES"
              if echo "$CHANGED_FILES" | grep -E '(^|/)composer\.json$|(^|/)composer\.lock$' >/dev/null; then
                echo "Se han detectado cambios en dependencias."
                echo 'COMPOSER_CHANGED=yes' >> "$BASH_ENV"
              else
                echo "No hay cambios en composer.json / composer.lock."
                echo 'COMPOSER_CHANGED=no' >> "$BASH_ENV"
              fi
            else
              echo "No hay commit previo (primer build); asumimos cambios en dependencias."
              echo 'COMPOSER_CHANGED=yes' >> "$BASH_ENV"
            fi

      - run:
          name: üß© Instalar dependencias PHP (composer, PROD)
          command: |
            if [ "$COMPOSER_CHANGED" = "yes" ]; then
              echo "COMPOSER_CHANGED=yes ‚Üí ejecutando composer install"
              composer install \
                --no-dev \
                --no-interaction \
                --prefer-dist \
                --optimize-autoloader
            else
              echo "COMPOSER_CHANGED=no ‚Üí se omite composer install"
            fi

      - run:
          name: üìÇ Listar directorio ra√≠z
          command: ls -la

      - run:
          name: üìÇ Listar directorio public
          command: |
            ls -la public || echo "No existe el directorio public"

      - run:
          name: üìÇ Listar directorio public/assets
          command: |
            ls -la public/assets || echo "No existe el directorio public/assets"

      - run:
          name: üõ†Ô∏è Instalar lftp
          command: |
            sudo apt-get update
            sudo apt-get install -y lftp

      - run:
          name: üìÇ Sync files (PROD, excepto public/, vendor y otros)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R . $intra_ftp_prod_path \
              --verbose \
              --exclude-glob public/** \
              --exclude-glob vendor/** \
              --exclude-glob .git/** \
              --exclude-glob .circleci/** \
              --exclude-glob .env \
              --exclude-glob .env.prod \
              --exclude-glob .env.dev \
              --exclude-glob .env.example \
              --exclude-glob composer.lock \
              --exclude-glob storage/logs/** \
              --exclude-glob config/local.php; \
              quit"

      - run:
          name: üì¶ Sync vendor (PROD)
          command: |
            if [ "$COMPOSER_CHANGED" = "yes" ]; then
              echo "COMPOSER_CHANGED=yes ‚Üí sincronizando vendor/"
              lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R vendor $intra_ftp_prod_path/vendor \
                --verbose; \
                quit"
            else
              echo "COMPOSER_CHANGED=no ‚Üí no se sincroniza vendor/"
            fi

      - run:
          name: üìÅ Update assets (PROD)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R $local_dir $intra_ftp_prod_assets_path --verbose; quit"

workflows:
  deploy-on-branches:
    jobs:
      - deploy-development:
          filters:
            branches:
              only: development

      - deploy-production:
          filters:
            branches:
              only: main
