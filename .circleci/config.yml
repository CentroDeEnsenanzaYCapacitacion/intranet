version: 2.1

jobs:
  deploy-development:
    docker:
      - image: cimg/php:8.2

    steps:
      - checkout

      - run:
          name: üîé Detect dependency changes (DEV)
          command: |
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              CHANGED_FILES="$(git diff --name-only HEAD^ HEAD)"
              echo "Modified files:"
              echo "$CHANGED_FILES"
              if echo "$CHANGED_FILES" | grep -E '(^|/)composer\.json$|(^|/)composer\.lock$' >/dev/null; then
                echo "Dependency changes detected."
                echo 'COMPOSER_CHANGED=yes' >> "$BASH_ENV"
              else
                echo "No changes in composer.json / composer.lock."
                echo 'COMPOSER_CHANGED=no' >> "$BASH_ENV"
              fi
            else
              echo "No previous commit (first build); assuming dependency changes."
              echo 'COMPOSER_CHANGED=yes' >> "$BASH_ENV"
            fi

      - run:
          name: üß© Install PHP dependencies (composer, DEV)
          command: |
            echo "Running composer install (DEV)"
            composer install \
              --no-interaction \
              --prefer-dist \
              --optimize-autoloader


      - run:
          name: üóÑÔ∏è Run migrations (DEV)
          command: |
            echo "Running migrations against DEV DB"
            export DB_HOST="$DB_HOST_DEV"
            export DB_PORT="$DB_PORT_DEV"
            export DB_DATABASE="$DB_DATABASE_DEV"
            export DB_USERNAME="$DB_USERNAME_DEV"
            export DB_PASSWORD="$DB_PASSWORD_DEV"

            php artisan migrate --force --no-interaction

      - run:
          name: üìÇ List root directory
          command: ls -la

      - run:
          name: üìÇ List public directory
          command: |
            ls -la public || echo "public directory does not exist"

      - run:
          name: üìÇ List public/assets directory
          command: |
            ls -la public/assets || echo "public/assets directory does not exist"

      - run:
          name: üõ†Ô∏è Install lftp
          command: |
            sudo apt-get update
            sudo apt-get install -y lftp

      - run:
          name: üìÇ Sync files (DEV, excluding public/, vendor and others)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R . $intra_ftp_dev_path \
              --verbose \
              --exclude-glob public/** \
              --exclude-glob vendor/** \
              --exclude-glob .git/** \
              --exclude-glob .circleci/** \
              --exclude-glob .env \
              --exclude-glob .env.prod \
              --exclude-glob .env.dev \
              --exclude-glob .env.example \
              --exclude-glob composer.lock \
              --exclude-glob storage/logs/** \
              --exclude-glob config/local.php; \
              quit"

      - run:
          name: üì¶ Sync vendor (DEV)
          command: |
            if [ "$COMPOSER_CHANGED" = "yes" ]; then
              echo "COMPOSER_CHANGED=yes ‚Üí syncing vendor/"
              lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R vendor $intra_ftp_dev_path/vendor \
                --verbose; \
                quit"
            else
              echo "COMPOSER_CHANGED=no ‚Üí vendor/ not synced"
            fi

      - run:
          name: üìÅ Update assets (DEV)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R $local_dir $intra_ftp_dev_assets_path \
              --verbose \
              --exclude-glob img/carousel/**; \
              quit"



  deploy-production:
    docker:
      - image: cimg/php:8.2

    steps:
      - checkout

      - run:
          name: üîé Detect dependency changes (PROD)
          command: |
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              CHANGED_FILES="$(git diff --name-only HEAD^ HEAD)"
              echo "Modified files:"
              echo "$CHANGED_FILES"
              if echo "$CHANGED_FILES" | grep -E '(^|/)composer\.json$|(^|/)composer\.lock$' >/dev/null; then
                echo "Dependency changes detected."
                echo 'COMPOSER_CHANGED=yes' >> "$BASH_ENV"
              else
                echo "No changes in composer.json / composer.lock."
                echo 'COMPOSER_CHANGED=no' >> "$BASH_ENV"
              fi
            else
              echo "No previous commit (first build); assuming dependency changes."
              echo 'COMPOSER_CHANGED=yes' >> "$BASH_ENV"
            fi

      - run:
          name: üß© Install PHP dependencies (composer, PROD)
          command: |
            echo "Running composer install (PROD)"
            composer install \
              --no-dev \
              --no-interaction \
              --prefer-dist \
              --optimize-autoloader


      - run:
          name: üóÑÔ∏è Run migrations (PROD)
          command: |
            echo "Running migrations against PROD DB"
            export DB_HOST="$DB_HOST_PROD"
            export DB_PORT="$DB_PORT_PROD"
            export DB_DATABASE="$DB_DATABASE_PROD"
            export DB_USERNAME="$DB_USERNAME_PROD"
            export DB_PASSWORD="$DB_PASSWORD_PROD"

            php artisan migrate --force --no-interaction

      - run:
          name: üìÇ List root directory
          command: ls -la

      - run:
          name: üìÇ List public directory
          command: |
            ls -la public || echo "public directory does not exist"

      - run:
          name: üìÇ List public/assets directory
          command: |
            ls -la public/assets || echo "public/assets directory does not exist"

      - run:
          name: üõ†Ô∏è Install lftp
          command: |
            sudo apt-get update
            sudo apt-get install -y lftp

      - run:
          name: üìÇ Sync files (PROD, excluding public/, vendor and others)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R . $intra_ftp_prod_path \
              --verbose \
              --exclude-glob public/** \
              --exclude-glob vendor/** \
              --exclude-glob .git/** \
              --exclude-glob .circleci/** \
              --exclude-glob .env \
              --exclude-glob .env.prod \
              --exclude-glob .env.dev \
              --exclude-glob .env.example \
              --exclude-glob composer.lock \
              --exclude-glob storage/logs/** \
              --exclude-glob config/local.php; \
              quit"

      - run:
          name: üì¶ Sync vendor (PROD)
          command: |
            if [ "$COMPOSER_CHANGED" = "yes" ]; then
              echo "COMPOSER_CHANGED=yes ‚Üí syncing vendor/"
              lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R vendor $intra_ftp_prod_path/vendor \
                --verbose; \
                quit"
            else
              echo "COMPOSER_CHANGED=no ‚Üí vendor/ not synced"
            fi

      - run:
          name: üìÅ Update assets (PROD)
          command: |
            lftp -u "$ftp_username","$ftp_password" "$ftp_url" -e "set ssl:verify-certificate no; mirror -R $local_dir $intra_ftp_prod_assets_path \
              --verbose \
              --exclude-glob img/carousel/**; \
              quit"



workflows:
  deploy-on-branches:
    jobs:
      - deploy-development:
          filters:
            branches:
              only: development

      - deploy-production:
          filters:
            branches:
              only: main
